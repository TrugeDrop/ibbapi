<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<link href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" rel="stylesheet"/>

<style>
    #search-container {
        display: flex;
        flex-direction: row;
        align-content: center;
        justify-content: center;
        align-items: center;
    }
    
    #search-container {
        height: 10%;
    }
    
    .searchBarTop {
        animation-name: search-bar-top-animation;
        animation-duration: 1s;
        animation-fill-mode: forwards;
    }
    
    @keyframes search-bar-top-animation {
        0% {
            height: 95%;
        }
        
        100% {
            height: 10%;
        }
    }
    
    #loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1200;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #content {
        display: none;
        align-items: center;
        justify-content: center;
        align-content: center;
    }
    
    @media screen and (max-width: 520px){
        #search-container {
            flex-direction: column;
        }
        
        #search {
            width: 75%!important;
        }
    }
    
    .container-fluid {
        position: absolute;
        top: 0;
        z-index: 1000;
    }
</style>

<div class="container-fluid">
    <form id="search-container" class="mt-3" onsubmit="searchFunc(event)" autocomplete="off">
        <h4 class="me-3">IBB API</h4>
        <input id="search" type="search" class="form-control" style="width: 50%;" placeholder="Hat veya Araç kapı no..." />
    </form>
    <button onclick="findLocation()" class="border-0 shadow bg-light p-1" style="font-size: 1.5rem; border-radius: 4px; position: absolute; right: 10px; top: 10px;"><i class="bi bi-geo-alt"></i></button>
</div>

<div id="map-content">
    <div id="map"></div>
</div>

<div id="loader"></div>

<script>
    /* loader */
    setTimeout(() => $('#loader').hide(), 500);
    
    /* map */
    var element = document.getElementById('map');
    element.style = 'height: 100%;';
    var map = L.map(element);
            
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
            
    var target = L.latLng(41.015137, 28.979530);

    map.setView(target, 11); 
    /* map end */
    
    /* layers */
    /*function addLayer(layer, multipleLayer){
        layers.forEach(data => {
            if(multipleLayer === true && data.options.title === layer.options.title) return;
            data.remove();
        });
        
        layers = layers.filter(function(a){
           if(multipleLayer === true){
               return a.options.title === layer.options.title;
           }
           return false;
        });
        
        Object.keys(map._layers).forEach(function(key) {
            let layer = map._layers[key];
            console.log(layer)
        });
        
    };*/
    
    function clearLayers(){
        Object.keys(map._layers).forEach(function(key) {
            if(key == 25) return;
            let layer = map._layers[key];
            if(layer.options.title === "Sen") return;
            layer.remove();
        });
    };
    /* layers end */
    
    function addToMap(e){
        if(e.unique === true){
            Object.keys(map._layers).forEach(function(key) {
                try{
                    let layer = map._layers[key];
                    if(layer && layer.options.title === e.name) layer.remove();
                }catch (e){
                    console.log(e);
                }
            });
        };
        
        if(e.multipleLayer !== true) clearLayers();
        
        let customIcon = {
            iconUrl: e.iconURL ? e.iconURL : "https://unpkg.com/leaflet@1.6.0/dist/images/marker-icon.png",
            iconSize:[30,30]
        }
                
        let myIcon = L.icon(customIcon);

        let iconOptions = {
            title: e.name,
            draggable: false,
            icon: myIcon
        }
                
        let marker = new L.Marker([e.coordinates[1], e.coordinates[0]], iconOptions);
        marker.addTo(map);
        marker.bindPopup(e.popupBind ? e.popupBind : `<h6>${e.name}</h6>`);
        
        if(e.openPopup === true) marker.openPopup();
        if(e.mapViewI) map.setView(L.latLng(e.coordinates[1], e.coordinates[0]), e.mapViewI);
    };
    
    function kapiNoTakip(kapiNo, callback){
        $.ajax({
            method: "GET",
            url: "/api/filo",
            data: {
                KapiNo: kapiNo
            },
            success: function(result){
                const arac = result.features[0];
                
                if(!arac) return callback({ status: 404 });
                
                clearLayers();
                    
                addToMap({
                    name: arac.properties.KapiNo,
                    coordinates: arac.geometry.coordinates,
                    mapViewI: 13,
                    addLayer: true
                });
                
                return callback({ status: 200 });
            },
            error: function(){
                return callback({ status: 404 });
            }
        });
    };
    
    function hatTakip(hatKodu, callback){
        $.ajax({
            method: "GET",
            url: "/api/hat-takip",
            data: {
                HatKodu: hatKodu
            },
            success: function(result){
                if(result.features.length <= 0) return callback({ status: 404 });
                
                clearLayers();

                result.features.forEach(e => {
                    addToMap({
                        name: e.properties.hatkodu,
                        coordinates: e.geometry.coordinates,
                        popupBind: `<div style="display: flex!important; align-content: center; flex-direction: row; align-items: center;"><b style="font-size: 1.5rem; margin-right: 0.5rem;">${e.properties.hatkodu}</b>${e.properties.hatad}</div>${e.properties.yon}`,
                        multipleLayer: true,
                        addLayer: true,
                        mapViewI: true
                     });
               });
                
                map.setZoom(13);
                
                return callback({ status: 200 });
           },
           error: function(){
               return callback({ status: 404 });
           }
       });
    };
    
    function searchFunc(event){
        event.preventDefault();
        $('#search').attr("disabled", true);
        $('#loader').show();
        
        const searchValue = event.target[0].value;
        
        hatTakip(searchValue, function(data){
           if(data.status !== 200){
               kapiNoTakip(searchValue, function(data){
                   $('#search').attr("disabled", false);
                   $('#loader').hide();
                   if(data.status !== 200) return alert("Sonuç bulunamadı!");
               });
           }else{
               $('#search').attr("disabled", false);
               $('#loader').hide();
           };
        });
    };
    
    function findLocation(){
        if (navigator.geolocation) {
            let {gc1, gc2} = [null, null];
            function position(){
                navigator.geolocation.getCurrentPosition(position => {                
                   if(gc1 === position.coords.longitude || gc2 === position.coords.latitude) return;
                    
                   gc1 = position.coords.longitude;
                   gc2 = position.coords.latitude;
                    
                   addToMap({
                       name: "Sen",
                       coordinates: [position.coords.longitude, position.coords.latitude],
                       mapViewI: 14,
                       iconURL: "/images/marker-circle.png",
                       unique: true,
                       multipleLayer: true
                   });
                });
            };
            position();
            setInterval(() => position(),5000);
        } else {
            alert("Coğrafi konum bu tarayıcı tarafından desteklenmiyor.");
        }
    };
</script>